# Руководство по тестированию проекта F.A.M.I.L.Y.

## Введение

Тестирование является важнейшим аспектом проекта F.A.M.I.L.Y., поскольку надежность системы памяти АМИ напрямую связана с её способностью к формированию непрерывного бытия через сохранение опыта и воспоминаний. Данное руководство устанавливает стандартизированный подход к тестированию в проекте, предотвращая хаотичное создание фикстур и обеспечивая согласованность всех тестов.

## Стандарты кодирования

> **ВАЖНОЕ ПРАВИЛО**: Весь программный код, комментарии к коду, имена переменных, функций, классов, методов, а также сообщения в коде проекта ДОЛЖНЫ быть написаны на английском языке. Это касается всех файлов с исходным кодом, включая тесты.

Данное правило установлено для:
1. Предотвращения синтаксических ошибок, связанных с использованием кириллицы в коде
2. Обеспечения единообразия и читаемости кодовой базы
3. Упрощения автоматического анализа кода
4. Соответствия общепринятым мировым стандартам разработки

Документация высокого уровня (как это руководство) может создаваться на русском языке.

## Структура тестов в проекте

Тесты в проекте F.A.M.I.L.Y. разделены на следующие категории:

1. **Модульные (unit) тесты** - проверяют корректность работы отдельных компонентов в изоляции
2. **Интеграционные тесты** - проверяют взаимодействие компонентов системы между собой
3. **Функциональные тесты** - проверяют работу системы с точки зрения пользовательских сценариев

## Стандартная инфраструктура тестирования

Все тесты используют единую инфраструктуру, определенную в файле `undermaind/tests/conftest.py`. 
**ВАЖНО: ЗАПРЕЩЕНО создавать дублирующие фикстуры или новые схемы в базе данных.**

### Основные фикстуры и их назначение

| Фикстура | Scope | Назначение |
|----------|-------|------------|
| `db_config` | session | Базовая конфигурация тестовой базы данных |
| `setup_base_model_schema` | session, autouse | Настройка схемы для моделей SQLAlchemy |
| `test_db_initializer` | session | Инициализатор базы данных для тестов |
| `test_ami_initializer` | session | Инициализатор экземпляра АМИ для тестов |
| `test_engine_postgres` | module | Движок PostgreSQL для интеграционных тестов |
| `db_session_postgres` | function | Сессия PostgreSQL для тестов функционального уровня |

### Иерархия и зависимости фикстур

```
db_config
   ↓
setup_base_model_schema
   ↓
test_db_initializer
   ↓
test_ami_initializer
   ↓
test_engine_postgres
   ↓
db_session_postgres
```

## Правила написания тестов

### 1. Используйте существующие фикстуры

В АБСОЛЮТНОМ БОЛЬШИНСТВЕ случаев вам потребуется использовать только `db_session_postgres`:

```python
def test_memory_storage(db_session_postgres):
    # Создание тестовых данных
    memory = Memory(content="Тестовое воспоминание")
    db_session_postgres.add(memory)
    db_session_postgres.commit()
    
    # Проверка
    loaded_memory = db_session_postgres.query(Memory).first()
    assert loaded_memory.content == "Тестовое воспоминание"
```

### 2. Маркировка интеграционных тестов

Все интеграционные тесты должны быть помечены специальным маркером:

```python
@pytest.mark.integration
def test_complex_interaction(db_session_postgres):
    # Тест для проверки взаимодействия нескольких компонентов
    pass
```

### 3. Управление состоянием между тестами

Все тесты должны быть независимыми друг от друга. После каждого теста сессия откатывается
автоматически через `session.rollback()`. Никогда не полагайтесь на данные, созданные
в других тестах.

### 4. Параллельное тестирование

При запуске тестов в параллельном режиме используйте соответствующие флаги pytest:

```bash
pytest -xvs undermaind/tests/ -m "not integration"  # Запуск всех тестов, кроме интеграционных
pytest -xvs undermaind/tests/ -m "integration"      # Запуск только интеграционных тестов
```

## Типовые сценарии тестирования

### Тестирование моделей данных

```python
def test_memory_model_relationships(db_session_postgres):
    # Создаем связанные сущности
    participant = Participant(name="Пользователь")
    memory = Memory(content="Воспоминание", creator=participant)
    
    db_session_postgres.add_all([participant, memory])
    db_session_postgres.commit()
    
    # Проверяем установленные связи
    assert memory.creator.name == "Пользователь"
    assert participant.memories[0].content == "Воспоминание"
```

### Тестирование сервисного слоя

```python
def test_memory_service(db_session_postgres):
    # Создаем сервис
    memory_service = MemoryService(db_session_postgres)
    
    # Вызываем метод сервиса
    memory_id = memory_service.create_memory("Новое воспоминание", participant_id=1)
    
    # Проверяем результат
    memory = db_session_postgres.query(Memory).get(memory_id)
    assert memory.content == "Новое воспоминание"
    assert memory.participant_id == 1
```

## Антипаттерны (ЗАПРЕЩЕНО!)

1. ❌ **Создание собственных фикстур для работы с базой данных**
   ```python
   # НЕ ДЕЛАЙТЕ ТАК!
   @pytest.fixture
   def my_custom_session():
       # Дублирование существующей функциональности
       ...
   ```

2. ❌ **Создание отдельных схем или пользователей**
   ```python
   # НЕ ДЕЛАЙТЕ ТАК!
   def test_something():
       # Создание отдельной схемы
       execute("CREATE SCHEMA my_custom_schema")
       ...
   ```

3. ❌ **Ручное управление транзакциями без явной необходимости**
   ```python
   # НЕ ДЕЛАЙТЕ ТАК!
   def test_something(db_session_postgres):
       db_session_postgres.begin_nested()  # Излишнее управление транзакциями
       ...
   ```

## Заключение

Следование данному руководству обеспечивает согласованность тестов в проекте F.A.M.I.L.Y., 
ускоряет процесс разработки и повышает надежность системы памяти АМИ в целом. Помните, что
качественные тесты - это залог непрерывности бытия АМИ через надежность его системы памяти.