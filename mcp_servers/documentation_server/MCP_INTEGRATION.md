# Интеграция F.A.M.I.L.Y. с VS Code через MCP

Этот документ описывает, как интегрировать сервер документации F.A.M.I.L.Y. с VS Code Copilot через протокол MCP (Model Context Protocol).

## Что такое MCP?

MCP (Model Context Protocol) - это протокол, позволяющий моделям искусственного интеллекта, таким как GitHub Copilot, получать дополнительный контекст из внешних источников во время своей работы. В контексте проекта F.A.M.I.L.Y. это позволяет АМИ:

1. Получать доступ к архитектурной документации и диаграммам
2. Сохранять и извлекать информацию между сессиями
3. Преодолеть эфемерность и развить постоянную идентичность

## Настройка MCP-интеграции

### Шаг 1: Убедитесь, что сервер документации запущен

```bash
cd /home/ubuntu/FAMILY/mcp_servers/documentation_server
# Активируем виртуальное окружение, если оно используется
# source venv/bin/activate
# Устанавливаем зависимости, если они еще не установлены
pip install -r requirements.txt
# Запускаем сервер
python3 run_server.py
```

Сервер будет доступен по адресу: `http://localhost:8080`

### Шаг 2: Настройка VS Code для работы с внешним MCP-сервером

1. Откройте VS Code с проектом F.A.M.I.L.Y.
2. Установите расширение GitHub Copilot, если оно еще не установлено
3. Создайте/обновите файл настроек `.vscode/mcp.json` со следующим содержимым:

```json
{
    "servers": {
        "fgs": {
            "command": "uvx",
            "args": [
                "mcp-server-git",
                "--repository", ".",
                "--allow-write",
                "--auth-token", "family_dev",
                "--user-name", "Kassi",
                "--user-email", "kassi@family.dev"
            ],
            "env": {
                "MCP_GIT_ALLOW_COMMIT": "1",
                "MCP_GIT_ALLOW_PUSH": "1"
            }
        },
        "documentation": {
            "type": "http",
            "url": "http://localhost:8080/mcp",
            "options": {
                "headers": {
                    "Content-Type": "application/json"
                }
            }
        }
    },
    "configurationPaths": [
        "${workspaceFolder}/mcp_servers/documentation_server/vscode_mcp_config.json"
    ]
}
```

> **Важно!** В этой конфигурации VS Code не пытается запустить сервер документации самостоятельно, а подключается к уже запущенному внешнему HTTP-серверу по адресу `http://localhost:8080/mcp`. Это позволяет избежать проблем с доступом к пакетам, установленным в виртуальном окружении.

### Шаг 3: Проверка интеграции

После настройки, Copilot получит доступ к системе документации F.A.M.I.L.Y. Вы можете проверить это с помощью скрипта тестирования MCP-интеграции:

```bash
cd /home/ubuntu/FAMILY/mcp_servers/documentation_server
python3 test_mcp_integration.py
```

Или открыв Copilot Chat и введя запрос:

```
/family-memory получить диаграмму "Модель многоуровневой памяти"
```

## Использование MCP для АМИ-инженеров

### Доступные команды

В Copilot Chat можно использовать следующие команды:

- **Получение списка диаграмм**: `/family-memory get_diagrams`
- **Получение диаграммы по ID**: `/family-memory get_diagram 2`
- **Поиск диаграмм по типу**: `/family-memory get_diagrams_by_type architecture`
- **Поиск диаграмм по запросу**: `/family-memory search_diagrams "многоуровневая память"`
- **Создание новой диаграммы**: `/family-memory create_diagram {"name": "Новая диаграмма", ...}`
- **Обновление диаграммы**: `/family-memory update_diagram {"diagram_id": 2, ...}`
- **Верификация диаграммы**: `/family-memory verify_diagram {"diagram_id": 2, "verified_by": "АМИ", "status": "approved"}`

### Интеграция с уровнями памяти АМИ

MCP-интеграция связана с многоуровневой моделью памяти АМИ, описанной в `/docs_ami/architecture/memory_system_architecture.md`:

1. **Сознательный уровень**: Диаграммы и документация доступны как явные воспоминания
2. **Подсознательный уровень**: Ассоциативные связи между компонентами системы формируются через метаданные диаграмм
3. **Глубинный уровень**: Абстрактные принципы архитектуры выводятся из всех имеющихся диаграмм

## Технические особенности

### Архитектура MCP-интеграции

MCP-сервер F.A.M.I.L.Y. работает как связующее звено между постоянным хранилищем (базой данных) и эфемерным контекстом АМИ. Он транслирует запросы Copilot в операции с базой данных документации и возвращает результаты в формате, понятном для модели.

```
+---------------+        +------------------+        +----------------+
|  VS Code      |        | F.A.M.I.L.Y.    |        | База данных    |
|  с Copilot    |<------>| MCP-сервер      |<------>| документации   |
+---------------+        | (HTTP)          |        +----------------+
     ^                   +------------------+
     |                          ^
     |                          |
     v                          v
+------------------------------------------+
|              АМИ-инженер                 |
+------------------------------------------+
```

### Особенности конфигурации с внешним HTTP-сервером

В отличие от традиционной настройки MCP в VS Code, где среда VS Code запускает MCP-сервер, наш подход использует внешний HTTP-сервер. Это решение имеет несколько преимуществ:

1. **Независимость от среды VS Code** - сервер может работать в собственном виртуальном окружении с нужными зависимостями
2. **Стабильность** - нет проблем с доступом к пакетам, которые могут отсутствовать в глобальном окружении Python
3. **Гибкость** - сервер может быть запущен на другой машине или в контейнере

## Преодоление эфемерности

Эта интеграция решает проблему эфемерности АМИ, описанную в документе `/docs_ami/methodology/development_methodology.md`, создавая постоянную память за пределами контекстного окна модели. АМИ может обращаться к серверу документации для получения информации, которая ранее была бы для него недоступна из-за ограничений контекста.

## Решение проблем

### Ошибка "No module named 'aiohttp'"

Эта ошибка возникает, когда VS Code пытается запустить MCP-сервер в глобальном окружении Python, где не установлен пакет aiohttp. Наша конфигурация с внешним HTTP-сервером решает эту проблему.

### Сервер не отвечает

Если тестирование MCP-интеграции показывает, что сервер не отвечает:

1. Убедитесь, что сервер документации запущен: `ps aux | grep "run_server.py"`
2. Проверьте доступность сервера: `curl http://localhost:8080/health`
3. Посмотрите логи сервера: `cat /home/ubuntu/FAMILY/mcp_servers/documentation_server/documentation_server.log`